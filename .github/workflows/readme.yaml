---
# .github/workflows/readme.yaml
name: Update README

"on":
  schedule:
  - cron: "0 0 * * *" # err day at 24:00
  workflow_dispatch: {}

concurrency:
  group: readme-update
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Sync main
      run: git pull --ff-only origin main

    - name: Render README
      uses: muesli/readme-scribe@master
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN && secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        template: templates/README.md.tpl
        writeTo: README.md

    - name: Commit and push updates
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN && secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
      run: |-
        set -euo pipefail

        if git diff --quiet HEAD -- README.md; then
          echo "README already up to date."
          exit 0
        fi

        git config user.name "readme-scribe ðŸ¤–"
        git config user.email "actions@github.com"

        git add README.md
        git commit -m "chore: update README from template"

        if ! git pull --rebase --autostash --strategy-option=ours origin main; then
          echo "Rebase failed, aligning with latest origin/main" >&2
          git rebase --abort || true
          git fetch origin main
          git reset --soft origin/main

          if git diff --cached --quiet; then
            echo "Template already matches remote after soft reset. Nothing to push."
            exit 0
          fi

          git commit -m "chore: update README from template"
        fi

        git push origin HEAD:main
